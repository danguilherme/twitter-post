<script src="bower_components/twitter-fetcher/js/twitterFetcher.js"></script>

<template>
  <style>
    :host {
      display: block;
      max-width: 100%;
    }

    progress {
      margin: 2em auto;
    }

    ul {
      margin: 0;
      padding: 0;

      list-style: none;
    }

    li {
      position: relative;
      padding: 12px;
      border-width: 0 1px 1px;
      border-style: solid;
      border-color: #e8e8e8;

      overflow: hidden;
    }

    :host(:not([hide-user])) li {
      padding-left: 69px;
    }

    :host(:not([hide-interaction])) li {
      padding-bottom: 1.2em;
    }

    li:first-child {
      border-top-width: 1px;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
    }

    li:last-child {
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }

    .user {
      position: relative;
    }

    .user img {
      position: absolute;
      top: 0;
      left: -57px;
      width: 48px;
      height: 48px;
      background: #fff;
      border-radius: 4px;
    }

    .user a {
      text-decoration: none;
    }

    .user span[data-scribe="element:name"] {
      font-weight: bold;
    }

    .user span[data-scribe="element:screen-name"] {

    }

    .tweet {
      margin: 3px 0 10px;
    }

    .timePosted,
    .interact {
      margin: 0;
    }

    .timePosted {
      position: absolute;
      top: 12px;
      right: 12px;
    }

    .interact {
      position: absolute;
      bottom: .1em;
      right: 12px;
    }

    .interact a {
      display: inline-block;
      margin-left: 5px;

      opacity: 0;
    }

    li:hover .interact a,
    li .interact a:focus {
      opacity: 1;
    }

    .media {
      text-align: center;
    }

    .media img {
      max-width: 100%;
    }
  </style>

  <progress indeterminate></progress>
  <div></div>
</template>

<script>
(function(window, document, undefined) {
    var thatDoc = document;
    var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;

    var template = thisDoc.querySelector('template').content;

    // Creates an object based in the HTML Element prototype
    var TwitterPostElementProto = Object.create(HTMLElement.prototype);
    // Registers all attributes with theirs default values
    TwitterPostElementProto.widgetId = null;
    TwitterPostElementProto.maxTweets = 20;
    TwitterPostElementProto.noLink = false;
    TwitterPostElementProto.hideUser = false;
    TwitterPostElementProto.hideTime = false;
    TwitterPostElementProto.hideRetweets = false;
    TwitterPostElementProto.hideInteraction = false;
    TwitterPostElementProto.images = false;
    TwitterPostElementProto.openLinksLocally = false;
    TwitterPostElementProto.language = 'en';
    TwitterPostElementProto.noPermalinks = false;

    // Fires when an instance of the element is created
    TwitterPostElementProto.createdCallback = function() {
      // Creates the shadow root
      var shadowRoot = this.createShadowRoot();
      // Adds a template clone into shadow root
      var clone = thatDoc.importNode(template, true);
      shadowRoot.appendChild(clone);

      this.progress = shadowRoot.querySelector('progress');
      this.target = shadowRoot.querySelector('div');

      // Checks if attributes already exist and modify them
      // widget-id
      if (this.hasAttribute('widget-id'))
        this.setWidgetId(this.getAttribute('widget-id'));
      else
        this.setWidgetId(this.widgetId);
      // max-tweets
      if (this.hasAttribute('max-tweets'))
        this.setMaxTweets(this.getAttribute('max-tweets'));
      else
        this.setMaxTweets(this.maxTweets);
      // no-link
      this.setHideLinks(this.hasAttribute('no-link'));
      // hide-user
      this.setHideUser(this.hasAttribute('hide-user'));
      // hide-time
      this.setHideTime(this.hasAttribute('hide-time'));
      // hide-retweets
      this.setHideRetweets(this.hasAttribute('hide-retweets'));
      // no-interaction
      this.setHideInteraction(this.hasAttribute('hide-interaction'));
      // images
      this.setShowImages(this.hasAttribute('images'));
      // open-links-locally
      this.setOpenLinksLocally(this.hasAttribute('open-links-locally'));
      // lang
      if (this.hasAttribute('lang'))
        this.setLanguage(this.getAttribute('lang'));
      else
        this.setLanguage(this.language);
      // no-permalink
      this.setHidePermalink(this.hasAttribute('no-permalink'));
      
      fetchTweets.call(this);
    };

    // Fires when an attribute was added, removed, or updated
    TwitterPostElementProto.attributeChangedCallback = function(attr, oldVal, newVal) {
      // if (!!this['set' + attr2var(attr)]) this['set' + attr2var(attr)](newVal);
      switch(attr) {
        case 'widget-id': this.setWidgetId(newVal); break;
        case 'max-tweets': this.setMaxTweets(newVal); break;
        case 'images': this.setShowImages(newVal); break;
        case 'lang': this.language(newVal); break;
      }

      if (oldVal !== newVal)
        fetchTweets.call(this);
    };

    // Create setters for all attributes
    TwitterPostElementProto.setWidgetId = function(val) {
      this.widgetId = val;
    };

    TwitterPostElementProto.setMaxTweets = function(val) {
      var n = Number(val);
      if (window.isNaN(n) ||
        n < 1 || n > 20)
        throw new Error("Maximum tweets property must be a number between 1 and 20.");
      this.maxTweets = n;
    };

    TwitterPostElementProto.setHideLinks = function(val) {
      if (val === true) {
        this.setAttribute('no-link', '');
      } else {
        this.removeAttribute('no-link');
      }
      this.noLink = this.hasAttribute('no-link');
    };

    TwitterPostElementProto.setHideUser = function(val) {
      if (val === true) {
        this.setAttribute('hide-user', '');
      } else {
        this.removeAttribute('hide-user');
      }
      this.hideUser = this.hasAttribute('hide-user');
    };

    TwitterPostElementProto.setHideTime = function(val) {
      if (val === true) {
        this.setAttribute('hide-time', '');
      } else {
        this.removeAttribute('hide-time');
      }
      this.hideTime = this.hasAttribute('hide-time');
    };

    TwitterPostElementProto.setHideRetweets = function(val) {
      if (val === true) {
        this.setAttribute('hide-retweets', '');
      } else {
        this.removeAttribute('hide-retweets');
      }
      this.hideRetweets = this.hasAttribute('hide-retweets');
    };

    TwitterPostElementProto.setHideInteraction = function(val) {
      if (val === true) {
        this.setAttribute('hide-interaction', '');
      } else {
        this.removeAttribute('hide-interaction');
      }
      this.hideInteraction = this.hasAttribute('hide-interaction');
    };

    TwitterPostElementProto.setShowImages = function(val) {
      if (val === true) {
        this.setAttribute('images', '');
      } else {
        this.removeAttribute('images');
      }
      this.images = this.hasAttribute('images');
    };

    TwitterPostElementProto.setOpenLinksLocally = function(val) {
      if (val === true) {
        this.setAttribute('open-links-locally', '');
      } else {
        this.removeAttribute('open-links-locally');
      }
      this.openLinksLocally = this.hasAttribute('open-links-locally');
    };

    TwitterPostElementProto.setLanguage = function(val) {
      this.language = val;
    };

    TwitterPostElementProto.setHidePermalink = function(val) {
      if (val === true) {
        this.setAttribute('no-permalink', '');
      } else {
        this.removeAttribute('no-permalink');
      }
      this.noPermalink = this.hasAttribute('no-permalink');
    };

    // Registers <twitter-post> in the main document
    window.TwitterPostElement = thatDoc.registerElement('twitter-post', {
      prototype: TwitterPostElementProto
    });

    // private methods
    function setLoading(isLoading) {
      if (isLoading) {
        this.progress.style.display = "block";
        this.target.style.display = "none";
      } else {
        this.progress.style.display = "none";
        this.target.style.display = "block";
      }
    }

    function handleTweets(tweets){
      var x = tweets.length;
      var n = 0;
      var element = this.target;
      var html = '<ul>';
      while(n < x) {
        html += '<li>' + tweets[n] + '</li>';
        n++;
      }
      html += '</ul>';
      element.innerHTML = html;

      setLoading.call(this, false);
    }

    function fetchTweets() {
        setLoading.call(this, true);
        
        twitterFetcher.fetch({
          id: this.widgetId,
          maxTweets: this.maxTweets,
          showImages: this.images,
          enableLinks: !this.noLink,
          showUser: !this.hideUser,
          showTime: !this.hideTime,
          showRetweet: !this.hideRetweets,
          showInteraction: !this.hideInteraction,
          showImages: this.images,
          linksInNewWindow: !this.openLinksLocally,
          lang: this.language,
          showPermalinks: !this.noPermalink,
          customCallback: handleTweets.bind(this)
        });
    }

    // helper methods
    function attr2var(attributeName) {
      var SEPARATOR_REGEXP = /\-+(.)/g;

      return attributeName.
        replace(SEPARATOR_REGEXP, function (_, letter, offset) {
          return offset ? letter.toUpperCase() : letter;
        });
    }

    function var2attr(attributeName) {
      var UPPER_CASE_LETTERS_REGEXP = /([A-Z])/g;

      return attributeName.
        replace(UPPER_CASE_LETTERS_REGEXP, function (_, letter, offset) {
          return offset ? '-' + letter.toLowerCase() : letter;
        });
    }

    function capitalizeFirstLetter(word) {
      return word.charAt(0).toUpperCase() + word.substring(1);
    }
})(window, document);
</script>