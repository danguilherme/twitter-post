<script src="../twitter-fetcher/js/twitterFetcher.js"></script>

<template>
  <style>
    :host {
      display: block;
      max-width: 100%;
      border: 1px solid #e8e8e8;
      border-radius: 5px;
    }

    progress {
      margin: 2em auto;
    }

    ul {
      margin: 0;
      padding: 0;
      list-style: none;
      border-radius: 5px;
    }

    li {
      position: relative;
      padding: 12px;
      overflow: hidden;
      border: solid #e8e8e8;
      border-width: 1px 0 0;
    }

    :host(:not([hide-user]):not([no-link])) li {
      padding-left: 69px;
    }

    :host(:not([hide-interaction])) li {
      padding-bottom: 1.2em;
    }

    li:first-child {
      border-top-width: 0;
    }

    .user {
      position: relative;
      margin: 0;
    }

    .user img {
      position: absolute;
      top: 0;
      left: -57px;
      width: 48px;
      height: 48px;
      background: #fff;
      border-radius: 4px;
      background-color: #f8f8f8;
    }

    .user a {
      text-decoration: none;
    }

    .user span[data-scribe="element:name"] {
      font-weight: bold;
    }

    .user span[data-scribe="element:screen-name"] {}

    .tweet {
      margin: 0;
    }

    .tweet img {
      width: 1em;
      height: auto;
      vertical-align: middle;
    }

    :host(:not([hide-user]):not([hide-time])) .tweet {
      margin-top: 3px;
    }

    :host([hide-user]:not([hide-time])) .tweet {
      margin-top: 1em;
    }

    .timePosted,
    .interact {
      margin: 0;
    }

    .timePosted {
      position: absolute;
      top: 12px;
      right: 12px;
    }

    .interact {
      position: absolute;
      bottom: .1em;
      right: 12px;
    }

    .interact a {
      display: inline-block;
      margin-left: 5px;
      opacity: 0;
    }

    li:hover .interact a,
    li .interact a:focus {
      opacity: 1;
    }

    .media {
      margin-top: 10px;
      text-align: center;
    }

    .media img {
      max-width: 100%;
    }
  </style>

  <progress indeterminate></progress>
  <div></div>
</template>

<script>
  (function(window, document, undefined) {
    var thatDoc = document;
    var thisDoc = (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;

    var DEFAULT_MAX_TWEETS = 20;
    var DEFAULT_LANGUAGE = 'en';

    var template = thisDoc.querySelector('template').content;

    // Creates an object based in the HTML Element prototype
    var TwitterPostElementProto = Object.create(HTMLElement.prototype);
    // Registers all attributes (element properties)
    Object.defineProperties(TwitterPostElementProto, {
      'widgetId': {
        get: function() {
          return this.getAttribute('widget-id');
        },
        set: function(val) {
          if (!val) val = '';
          this.setAttribute('widget-id', val);
        }
      },
      'maxTweets': {
        get: function() {
          return Number(this.getAttribute('max-tweets')) || DEFAULT_MAX_TWEETS;
        },
        set: function(val) {
          var n = Number(val);
          if (window.isNaN(n) ||
            n < 1 || n > 20)
            throw new Error("Maximum tweets property must be a number between 1 and 20.");
          this.setAttribute('max-tweets', n);
        }
      },
      'noLink': {
        get: function() {
          return this.hasAttribute('no-link');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('no-link', '');
          else
            this.removeAttribute('no-link');
        }
      },
      'hideUser': {
        get: function() {
          return this.hasAttribute('hide-user');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('hide-user', '');
          else
            this.removeAttribute('hide-user');
        }
      },
      'hideTime': {
        get: function() {
          return this.hasAttribute('hide-time');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('hide-time', '');
          else
            this.removeAttribute('hide-time');
        }
      },
      'hideRetweets': {
        get: function() {
          return this.hasAttribute('hide-retweets');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('hide-retweets', '');
          else
            this.removeAttribute('hide-retweets');
        }
      },
      'hideInteraction': {
        get: function() {
          return this.hasAttribute('hide-interaction');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('hide-interaction', '');
          else
            this.removeAttribute('hide-interaction');
        }
      },
      'images': {
        get: function() {
          return this.hasAttribute('images');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('images', '');
          else
            this.removeAttribute('images');
        }
      },
      'openLinksLocally': {
        get: function() {
          return this.hasAttribute('open-links-locally');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('open-links-locally', '');
          else
            this.removeAttribute('open-links-locally');
        }
      },
      'lang': {
        get: function() {
          return this.getAttribute('lang') || DEFAULT_LANGUAGE;
        },
        set: function(val) {
          this.setAttribute('lang', val);
        }
      },
      'noPermalinks': {
        get: function() {
          return this.hasAttribute('no-permalink');
        },
        set: function(val) {
          if (val === true)
            this.setAttribute('no-permalink', '');
          else
            this.removeAttribute('no-permalink');
        }
      }
    });

    // Fires when an instance of the element is created
    TwitterPostElementProto.createdCallback = function() {
      // Creates the shadow root
      var shadowRoot = this.createShadowRoot();
      // Adds a template clone into shadow root
      var clone = thatDoc.importNode(template, true);
      shadowRoot.appendChild(clone);

      this.progress = shadowRoot.querySelector('progress');
      this.contentTarget = shadowRoot.querySelector('div');

      if (!!this.widgetId)
        this.fetchTweets();
    };

    // Fires when an attribute was added, removed, or updated
    // TwitterPostElementProto.attributeChangedCallback = function(attr, oldVal, newVal) {
    //   console.debug("attr set: " + attr2var(attr), oldVal, '=>', newVal);
    //   if (oldVal == newVal) return;
    //
    //   this[attr2var(attr)] = newVal;
    // };

    // public methods
    TwitterPostElementProto.fetchTweets = function() {
      if (!this.widgetId)
        throw new Error("Widget ID must be set to fetch the tweets.");

      setLoading.call(this, true);

      twitterFetcher.fetch({
        id: this.widgetId,
        maxTweets: this.maxTweets,
        showImages: this.images,
        enableLinks: !this.noLink,
        showUser: !this.hideUser,
        showTime: !this.hideTime,
        showRetweet: !this.hideRetweets,
        showInteraction: !this.hideInteraction,
        showImages: this.images,
        linksInNewWindow: !this.openLinksLocally,
        lang: this.lang,
        showPermalinks: !this.noPermalink,
        customCallback: handleTweets.bind(this)
      });
    };

    // Registers <twitter-post> in the main document
    window.TwitterPostElement = thatDoc.registerElement('twitter-post', {
      prototype: TwitterPostElementProto
    });

    // private methods
    function setLoading(isLoading) {
      if (isLoading) {
        this.progress.style.display = "block";
        this.contentTarget.style.display = "none";
      } else {
        this.progress.style.display = "none";
        this.contentTarget.style.display = "block";
      }
    }

    function handleTweets(tweets) {
      var i = 0,
        l = tweets.length;
      var element = this.contentTarget;
      var tweetsList = document.createElement('ul');
      var html = '';

      // clear the element
      element.innerHTML = '';

      for (i = 0; i < l; i++) {
        var tweet = document.createElement('li');
        tweet.innerHTML = tweets[i];
        var tweetTextEl = tweet.querySelector('.tweet');

        // if images are set to be shown,
        // remove their `pic.twitter.com` link
        if (this.images) {
          var mediaLink = getTweetMediaLink(tweetTextEl.textContent);

          // is there a media link?
          if (mediaLink) {
            var mediaDiv = tweet.querySelector('.media');

            // for some reason, some tweets still with 'show images'
            // set to true, does not show theirs image, so we let
            // them untouched
            if (mediaDiv) {
              // wrap the image in an an anchor (<a>)
              // to take the user to the picture
              var mediaAnchor = document.createElement('a');

              tweet.replaceChild(mediaAnchor, mediaDiv);
              mediaAnchor.href = "https://" + mediaLink;
              mediaAnchor.appendChild(mediaDiv);

              // remove the `pic.twitter.com` from the tweet
              tweetTextEl.lastChild.remove();
            }
          }
        }

        tweetsList.appendChild(tweet);
      }

      // fix tweets images
      var profilePictures = tweetsList.querySelectorAll('[data-src-1x]');
      for (i = 0; i < profilePictures.length; i++) {
        profilePictures[i].setAttribute('src', profilePictures[i].getAttribute('data-src-1x'))
      }

      element.appendChild(tweetsList);

      setLoading.call(this, false);

      this.dispatchEvent(new Event('tweetrender'));
    }

    function getTweetMediaLink(tweetStr) {
      var match = tweetStr.match(/(pic\.twitter\.com\/\S*)$/);
      if (match)
        return match[1];
      return null;
    }

    // helper methods
    function attr2var(attributeName) {
      var SEPARATOR_REGEXP = /\-+(.)/g;

      return attributeName.
      replace(SEPARATOR_REGEXP, function(_, letter, offset) {
        return offset ? letter.toUpperCase() : letter;
      });
    }

    function var2attr(attributeName) {
      var UPPER_CASE_LETTERS_REGEXP = /([A-Z])/g;

      return attributeName.
      replace(UPPER_CASE_LETTERS_REGEXP, function(_, letter, offset) {
        return offset ? '-' + letter.toLowerCase() : letter;
      });
    }

    function capitalizeFirstLetter(word) {
      return word.charAt(0).toUpperCase() + word.substring(1);
    }
  })(window, document);
</script>
